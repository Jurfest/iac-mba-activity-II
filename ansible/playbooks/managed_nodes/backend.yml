---
#

- name: Configure backend - Prebuild
  hosts: managed_app_node
  become: true

  tags:
    - be-pre-build

  tasks:
    # Print a success message for debugging purposes
    - name: Print success message
      debug:
        msg: "The backend playbook ran successfully."

    - name: Install Go
      import_role:
        name: abdennour.golang
      vars:
        golang_version: "1.14"
        golang_packages:
          - github.com/gorilla/mux
          - go.mongodb.org/mongo-driver/mongo # go get go.mongodb.org/mongo-driver/mongo
        golang_users:
          - "{{ ansible_ssh_user }}"

- name: Play backend - Build
  hosts: managed_app_node
  become: true

  vars:
    be_build_workspace: /opt/build_dir
    be_repo_url: https://github.com/kubernetes-tn/go-to-do-app.git
    be_repo_name: go-to-do-app

  tags:
    - be-build

  tasks:
    - name: workspace build exists
      file:
        path: "{{ be_build_workspace }}"
        state: directory

    - name: Check if the repository directory exists
      stat:
        path: "{{ be_build_workspace }}/{{ be_repo_name }}"
      register: repo_dir_status

    - name: Fetch the code if repository directory doesn't exist
      git:
        repo: "{{ be_repo_url }}"
        dest: "{{ be_build_workspace }}/{{ be_repo_name }}"
      when: not repo_dir_status.stat.exists

    - name: go build
      # shell: . /etc/profile;go build -o {{ be_tmp_bin }}
      shell: . /etc/profile;go build -o /tmp/todo
      args:
        chdir: "{{ be_build_workspace }}/{{ be_repo_name }}/server"

- name: Play backend - Deploy
  hosts: managed_app_node
  become: true

  tags:
    - be-deploy

  tasks:
    # 1 - Create Systemd Service Todo which populates (2) & manages (3)
    #       -> notify: `systemctl reload-daemon`
    - name: systemd service todo is generated
      template:
        src: todo.service.j2
        dest: /lib/systemd/system/todo.service
      notify: systemd reloaded
      
      # 2 - Put env vars in seperated file ( `/etc/todo.env`)
    - name: todo env file is generated
      include_tasks: tasks/backend_env_file.yaml

      # 3 - Move buid file from `/tmp/todo` to a standard place (`/usr/local/bin/todo`)
      #       -> notify: `systemctl restart todo`
    - name: backend is deployed
      copy:
        src: "{{ be_tmp_bin }}"
        dest: "{{ be_prod_bin }}"
        mode: a+x
        remote_src: yes
      notify: backend restarted
  handlers:
    - name: systemd reloaded
      systemd:
        daemon_reload: yes
    - name: backend restarted
      service:
        name: todo
        state: restarted
