---
# 

- name: Configure backend - Prebuild
  hosts: managed_app_node
  become: true

  tags:
      - be-pre-build

  tasks:
    # Print a success message for debugging purposes
    - name: Print success message
      debug:
        msg: "The backend playbook ran successfully."

    - name: Install Go
      import_role:
        name: abdennour.golang
      vars:
        golang_version: "1.14"
        golang_packages:
        - github.com/gorilla/mux
        - go.mongodb.org/mongo-driver/mongo # go get go.mongodb.org/mongo-driver/mongo
        golang_users:
        - "{{ ansible_ssh_user }}"

- name: Play backend - Build
  hosts: managed_app_node
  become: true

  vars:
      be_build_workspace: /opt/build_dir
      be_repo_url: https://github.com/kubernetes-tn/go-to-do-app.git
      be_repo_name: go-to-do-app

  tags:
      - be-build

  tasks:
    - name: workspace build exists
      file:
        path: "{{ be_build_workspace }}"
        state: directory

    - name: Check if the repository directory exists
      stat:
        path: "{{ be_build_workspace }}/{{ be_repo_name }}"
      register: repo_dir_status

    - name: Fetch the code if repository directory doesn't exist
      git:
        repo: "{{ be_repo_url }}"
        dest: "{{ be_build_workspace }}/{{ be_repo_name }}"
      when: not repo_dir_status.stat.exists

    - name: go build
      # shell: . /etc/profile;go build -o {{ be_tmp_bin }}
      shell: . /etc/profile;go build -o /tmp/todo
      args:
        chdir: "{{ be_build_workspace }}/{{ be_repo_name }}/server"

- name: Play backend - Deploy
  hosts: managed_app_node
  become: true

  tags:
      - be-deploy

  tasks: []